version: '3.3'

services:
  login:
    environment:
      - RESOURCES_URL=https://resources.${HOSTNAME}
      - HOST=${HOSTNAME}
    deploy:
      labels:
        - 'traefik.enable=true'
        - 'traefik.frontend.rule=Host: login.${HOSTNAME}'
        - 'traefik.port=80'
        - 'traefik.docker.network=opencrvs_overlay_net'
      replicas: 2
    networks:
      - overlay_net

  # Configure other service with deployment specifc details
  auth:
    secrets:
      - jwt-public-key
      - jwt-private-key
    environment:
      - CERT_PRIVATE_KEY_PATH=/run/secrets/jwt-private-key
      - CERT_PUBLIC_KEY_PATH=/run/secrets/jwt-public-key
    deploy:
      labels:
        - 'traefik.enable=true'
        - 'traefik.frontend.rule=Host: auth.${HOSTNAME}'
        - 'traefik.port=4040'
        - 'traefik.docker.network=opencrvs_overlay_net'
      replicas: 2
    networks:
      - overlay_net

  user-mgnt:
    secrets:
      - jwt-public-key
    environment:
      - CERT_PUBLIC_KEY_PATH=/run/secrets/jwt-public-key
      - MONGO_URL=mongodb://mongo1,mongo2,mongo3/user-mgnt?replicaSet=rs0
    deploy:
      replicas: 2
    networks:
      - overlay_net

  notification:
    secrets:
      - jwt-public-key
    environment:
      - CERT_PUBLIC_KEY_PATH=/run/secrets/jwt-public-key
    deploy:
      replicas: 2
    networks:
      - overlay_net

  gateway:
    secrets:
      - jwt-public-key
    volumes:
      - '.secrets/public-key.pem:/secrets/public-key.pem'
    environment:
      - CERT_PUBLIC_KEY_PATH=/run/secrets/jwt-public-key
    deploy:
      labels:
        - 'traefik.enable=true'
        - 'traefik.frontend.rule=Host: gateway.${HOSTNAME}'
        - 'traefik.port=7070'
        - 'traefik.docker.network=opencrvs_overlay_net'
      replicas: 2
    networks:
      - overlay_net

  workflow:
    secrets:
      - jwt-public-key
    environment:
      - CERT_PUBLIC_KEY_PATH=/run/secrets/jwt-public-key
    deploy:
      replicas: 2
    networks:
      - overlay_net

  search:
    secrets:
      - jwt-public-key
    environment:
      - CERT_PUBLIC_KEY_PATH=/run/secrets/jwt-public-key
    deploy:
      replicas: 2
    networks:
      - overlay_net

  metrics:
    secrets:
      - jwt-public-key
    environment:
      - CERT_PUBLIC_KEY_PATH=/run/secrets/jwt-public-key
    deploy:
      replicas: 2
    networks:
      - overlay_net
  webhooks:
    secrets:
      - jwt-public-key
    environment:
      - MONGO_URL=mongodb://mongo1,mongo2,mongo3/webhooks?replicaSet=rs0
      - CERT_PUBLIC_KEY_PATH=/run/secrets/jwt-public-key
    deploy:
      labels:
        - 'traefik.enable=true'
        - 'traefik.frontend.rule=Host: webhooks.${HOSTNAME}'
        - 'traefik.port=2525'
        - 'traefik.docker.network=opencrvs_overlay_net'
      replicas: 2
    networks:
      - overlay_net

secrets:
  jwt-public-key:
    external: true
  jwt-private-key:
    external: true

networks:
  overlay_net:
    external:
      name: infrastructure_overlay_net
